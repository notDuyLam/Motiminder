<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motiminder - Reminder App</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
        appId: "41cfcf56-1091-4418-b997-a08b75f114cf",
        safari_web_id: "web.onesignal.auto.532534a2-fa6b-4796-aab8-c4e8f72a79c0",
        notifyButton: {
            enable: true,
        },
        });

        // Debug: Check if user is subscribed
        const isSubscribed = await OneSignal.User.PushSubscription.optedIn;
        console.log('OneSignal subscription status:', isSubscribed);
        
        // Debug: Get user ID
        const userId = await OneSignal.User.PushSubscription.id;
        console.log('OneSignal User ID:', userId);
        
        // Debug: Check notification permission
        console.log('Notification permission:', Notification.permission);
    });
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Motiminder</h1>
            <p class="subtitle">Stay organized with smart reminders</p>
        </header>
        
        <main>
            <div class="reminder-form">
                <h2>Create New Reminder</h2>
                
                <form id="reminderForm">
                    <div class="form-group">
                        <label for="title">Reminder Title</label>
                        <input 
                            type="text" 
                            id="title" 
                            name="title" 
                            placeholder="Enter reminder title..."
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea 
                            id="description" 
                            name="description" 
                            placeholder="Add description (optional)..."
                            rows="4"
                        ></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderTime">Reminder Time</label>
                        <input 
                            type="datetime-local" 
                            id="reminderTime" 
                            name="reminderTime"
                            required
                        >
                    </div>
                    
                    <button type="submit" class="create-btn">
                        <span class="btn-icon">üìÖ</span>
                        Create Reminder
                    </button>
                </form>
                
                <!-- Test Notification Button -->
                <button onclick="testNotification()" class="test-btn" style="margin-top: 15px; background: #22c55e;">
                    <span class="btn-icon">üîî</span>
                    Test Notification
                </button>
            </div>
            
            <div class="reminders-list">
                <h3>Your Reminders</h3>
                <div id="remindersList" class="reminders-container">
                    <!-- Reminders will be displayed here -->
                    <div class="no-reminders">
                        <p>No reminders yet. Create your first reminder above!</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        const API_BASE_URL = 'https://motiminder-backend.vercel.app/api';

        // Load existing reminders when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadReminders();
        });

        // Form handling
        document.getElementById('reminderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const reminderTime = document.getElementById('reminderTime').value;
            
            if (title && reminderTime) {
                try {
                    const response = await fetch(`${API_BASE_URL}/reminders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title,
                            description,
                            reminderTime
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Reset form
                        this.reset();
                        
                        // Show success message
                        showMessage('Reminder created successfully!', 'success');
                        
                        // Reload reminders list
                        loadReminders();
                    } else {
                        showMessage(result.error || 'Failed to create reminder', 'error');
                    }
                } catch (error) {
                    console.error('Error creating reminder:', error);
                    showMessage('Failed to connect to server', 'error');
                }
            }
        });

        // Load and display reminders
        async function loadReminders() {
            try {
                const response = await fetch(`${API_BASE_URL}/reminders`);
                const result = await response.json();
                
                if (result.success) {
                    displayReminders(result.reminders);
                }
            } catch (error) {
                console.error('Error loading reminders:', error);
            }
        }

        // Display reminders in the UI
        function displayReminders(reminders) {
            const container = document.getElementById('remindersList');
            
            if (reminders.length === 0) {
                container.innerHTML = `
                    <div class="no-reminders">
                        <p>No reminders yet. Create your first reminder above!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = reminders.map(reminder => {
                const reminderDate = new Date(reminder.reminderTime);
                const isOverdue = reminderDate < new Date();
                const statusClass = reminder.sent ? 'sent' : (isOverdue ? 'overdue' : 'pending');
                
                return `
                    <div class="reminder-item ${statusClass}">
                        <div class="reminder-header">
                            <h4>${reminder.title}</h4>
                            <span class="reminder-status">${reminder.sent ? '‚úÖ Sent' : (isOverdue ? '‚ö†Ô∏è Overdue' : '‚è∞ Pending')}</span>
                        </div>
                        ${reminder.description ? `<p class="reminder-description">${reminder.description}</p>` : ''}
                        <div class="reminder-time">
                            üìÖ ${reminderDate.toLocaleString()}
                        </div>
                        <button onclick="deleteReminder(${reminder.id})" class="delete-btn">Delete</button>
                    </div>
                `;
            }).join('');
        }

        // Delete reminder
        async function deleteReminder(id) {
            if (!confirm('Are you sure you want to delete this reminder?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/reminders/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('Reminder deleted successfully', 'success');
                    loadReminders();
                } else {
                    showMessage(result.error || 'Failed to delete reminder', 'error');
                }
            } catch (error) {
                console.error('Error deleting reminder:', error);
                showMessage('Failed to connect to server', 'error');
            }
        }

        // Show message to user
        function showMessage(message, type) {
            // Remove existing messages
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            // Insert at top of container
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.firstChild);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Test notification function
        async function testNotification() {
            try {
                const response = await fetch(`${API_BASE_URL}/test-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: 'Test Notification',
                        message: 'Hello from Motiminder! üéâ'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('Test notification sent! Check your notifications.', 'success');
                } else {
                    showMessage('Failed to send test notification: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error sending test notification:', error);
                showMessage('Failed to connect to server', 'error');
            }
        }
    </script>
</body>
</html>